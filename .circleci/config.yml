version: 2.1
jobs:
  go-test:
    machine: true
    steps:
      - checkout
      - run: |
          docker run --rm --network host \
            -v `pwd`/service-go:/app \
            -v /var/run/docker.sock:/var/run/docker.sock \
            -w /app golang:1.17.5 \
            go test ./... -race -timeout 5m
  
  go-build:
    docker:
      - image: cimg/go:1.17.5
    steps:
      - checkout
      - run: |
          cd ./service-go
          go build -o bin/ ./cmd/iam/...
          go build -o bin/ ./cmd/confa/...
          go build -o bin/ ./cmd/rtc/...
          go build -o bin/ ./cmd/gateway/...
          go build -o bin/ ./cmd/sfu/...
          go build -o bin/ ./cmd/tracker/...
          go build -o bin/ ./cmd/avp/...
  
  web-build:
    docker:
      - image: cimg/node:17.7.2
    steps:
      - checkout
      - restore_cache:
          keys:
            - web-v1-{{ checksum "web/pnpm-lock.yaml" }}
            - web-v1
      - run: |
          cd ./web
          sudo npm install --unsafe-perm -g pnpm@7.1.0
          pnpm install
          pnpm run build
      - save_cache:
          key: web-v1-{{ checksum "web/pnpm-lock.yaml" }}
          paths:
            - web/node_modules
            - web/.pnpm-store

  web-lint:
    docker:
      - image: cimg/node:17.7.2
    steps:
      - checkout
      - restore_cache:
          keys:
            - web-v1-{{ checksum "web/pnpm-lock.yaml" }}
            - web-v1
      - run: |
          cd ./web
          sudo npm install --unsafe-perm -g pnpm
          pnpm install
          pnpm run lint
          git diff --exit-code
      - save_cache:
          key: web-v1-{{ checksum "web/pnpm-lock.yaml" }}
          paths:
            - web/node_modules
            - web/.pnpm-store

  go-lint:
    docker:
      - image: golangci/golangci-lint:v1.45-alpine
    steps:
      - checkout
      - run: |
          cd ./service-go
          golangci-lint run

workflows:
  version: 2
  build:
    jobs:
      - go-build
      - go-test
      - go-lint
      - web-build
      - web-lint
